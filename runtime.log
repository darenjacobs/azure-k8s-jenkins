+ set -euo pipefail
+++ dirname install.sh
++ cd .
++ pwd
+ CWD=/home/ec2-user/github/azure-k8s-jenkins
+ LOCATION=eastus
+ RESOURCE_GROUP=demo-kube
+ AKS_CLUSTER=demo-cluster
+ ACR_NAME=democontainer22466
+ EMAIL=daren.jacobs@fhlbny.com
+ func_create_images
++ tail -1
++ awk '{print $1}'
++ docker images
+ is_images=REPOSITORY
+ '[' REPOSITORY == REPOSITORY ']'
+ echo 'Creating Docker images'
Creating Docker images
+ '[' -d /home/ec2-user/github/azure-voting-app-redis ']'
+ cd /home/ec2-user/github/azure-voting-app-redis
+ docker-compose up -d
Creating network "azurevotingappredis_default" with the default driver
Pulling azure-vote-back (redis:latest)...
latest: Pulling from library/redis
Digest: sha256:6b9f935e89af002225c0dcdadf1fd74245b4cc1e3e91222f7e4769c236cf80d4
Status: Downloaded newer image for redis:latest
Building azure-vote-front
Step 1/3 : FROM    tiangolo/uwsgi-nginx-flask:python3.6
python3.6: Pulling from tiangolo/uwsgi-nginx-flask
Digest: sha256:5418a1a7e0774e7ed81386752dc1f6a95ce0c4bbe052dc3dbaeaec26b1f33470
Status: Downloaded newer image for tiangolo/uwsgi-nginx-flask:python3.6
 ---> d86bce082fbe
Step 2/3 : RUN     pip install redis
 ---> Running in d52e332da406
Collecting redis
  Downloading https://files.pythonhosted.org/packages/3b/f6/7a76333cf0b9251ecf49efff635015171843d9b977e4ffcf59f9c4428052/redis-2.10.6-py2.py3-none-any.whl (64kB)
Installing collected packages: redis
Successfully installed redis-2.10.6
[91mYou are using pip version 9.0.3, however version 10.0.1 is available.
You should consider upgrading via the 'pip install --upgrade pip' command.
[0mRemoving intermediate container d52e332da406
 ---> 0b630412bf88
Step 3/3 : ADD     /azure-vote /app
 ---> 51f058d1d3d5
Successfully built 51f058d1d3d5
Successfully tagged azure-vote-front:latest
Image for service azure-vote-front was built because it did not already exist. To rebuild this image you must use `docker-compose build` or `docker-compose up --build`.
Creating azure-vote-back ... 
Creating azure-vote-front ... 
[2A[2KCreating azure-vote-back  ... [32mdone[0m[2B[1A[2KCreating azure-vote-front ... [32mdone[0m[1B+ docker-compose stop
Stopping azure-vote-front ... 
Stopping azure-vote-back  ... 
[1A[2KStopping azure-vote-back  ... [32mdone[0m[1B[2A[2KStopping azure-vote-front ... [32mdone[0m[2B+ docker-compose down
Removing azure-vote-front ... 
Removing azure-vote-back  ... 
[2A[2KRemoving azure-vote-front ... [32mdone[0m[2B[1A[2KRemoving azure-vote-back  ... [32mdone[0m[1BRemoving network azurevotingappredis_default
+ func_create_images
++ docker images
++ tail -1
++ awk '{print $1}'
+ is_images=redis
+ '[' redis == REPOSITORY ']'
+ cd /home/ec2-user/github/azure-k8s-jenkins
+ cd /home/ec2-user/github/azure-k8s-jenkins
+ az group create -n demo-kube -l eastus
{
  "id": "/subscriptions/8fc81d30-44f2-4be2-b49a-1f3537b4d50a/resourceGroups/demo-kube",
  "location": "eastus",
  "managedBy": null,
  "name": "demo-kube",
  "properties": {
    "provisioningState": "Succeeded"
  },
  "tags": null
}
+ az acr create -n democontainer22466 -g demo-kube --sku Basic
{
  "adminUserEnabled": false,
  "creationDate": "2018-04-25T18:34:49.740222+00:00",
  "id": "/subscriptions/8fc81d30-44f2-4be2-b49a-1f3537b4d50a/resourceGroups/demo-kube/providers/Microsoft.ContainerRegistry/registries/democontainer22466",
  "location": "eastus",
  "loginServer": "democontainer22466.azurecr.io",
  "name": "democontainer22466",
  "provisioningState": "Succeeded",
  "resourceGroup": "demo-kube",
  "sku": {
    "name": "Basic",
    "tier": "Basic"
  },
  "status": null,
  "storageAccount": null,
  "tags": {},
  "type": "Microsoft.ContainerRegistry/registries"
}
+ az acr login -n democontainer22466
Login Succeeded
+ docker images
REPOSITORY                   TAG                 IMAGE ID            CREATED              SIZE
azure-vote-front             latest              51f058d1d3d5        About a minute ago   937MB
tiangolo/uwsgi-nginx-flask   python3.6           d86bce082fbe        6 days ago           937MB
redis                        latest              c5355f8853e4        4 weeks ago          107MB
++ az acr list -g demo-kube --query '[].{acrLoginServer:loginServer}' --output tsv
+ export ACR_SERVER=democontainer22466.azurecr.io
+ ACR_SERVER=democontainer22466.azurecr.io
+ docker tag azure-vote-front democontainer22466.azurecr.io/azure-vote-front:v1
+ docker images
REPOSITORY                                       TAG                 IMAGE ID            CREATED              SIZE
democontainer22466.azurecr.io/azure-vote-front   v1                  51f058d1d3d5        About a minute ago   937MB
azure-vote-front                                 latest              51f058d1d3d5        About a minute ago   937MB
tiangolo/uwsgi-nginx-flask                       python3.6           d86bce082fbe        6 days ago           937MB
redis                                            latest              c5355f8853e4        4 weeks ago          107MB
+ docker push democontainer22466.azurecr.io/azure-vote-front:v1
The push refers to repository [democontainer22466.azurecr.io/azure-vote-front]
9d7471a4cb02: Preparing
17c1e8f9ffc3: Preparing
91d4946853b1: Preparing
cab1a1b91f96: Preparing
2689339b3663: Preparing
481318f44378: Preparing
a607e4e78166: Preparing
39e2be22c2a5: Preparing
9dcde2bd7f22: Preparing
0d701ea07f21: Preparing
ba1caa9ad1b8: Preparing
902245526746: Preparing
b800a9224768: Preparing
efba3aa8a05c: Preparing
a17e9881496c: Preparing
60e1a8618c67: Preparing
6c7b9546171d: Preparing
303c11dcd890: Preparing
746cca6f1abf: Preparing
dc918b50a9e0: Preparing
3b9f5a79fc86: Preparing
80ab47649ccb: Preparing
6691330056f3: Preparing
bc0d5482d762: Preparing
44246ca595f6: Preparing
20c527f217db: Preparing
61c06e07759a: Preparing
bcbe43405751: Preparing
e1df5dc88d2c: Preparing
481318f44378: Waiting
a607e4e78166: Waiting
39e2be22c2a5: Waiting
9dcde2bd7f22: Waiting
0d701ea07f21: Waiting
ba1caa9ad1b8: Waiting
902245526746: Waiting
b800a9224768: Waiting
efba3aa8a05c: Waiting
a17e9881496c: Waiting
60e1a8618c67: Waiting
6c7b9546171d: Waiting
303c11dcd890: Waiting
746cca6f1abf: Waiting
dc918b50a9e0: Waiting
3b9f5a79fc86: Waiting
80ab47649ccb: Waiting
6691330056f3: Waiting
bc0d5482d762: Waiting
44246ca595f6: Waiting
20c527f217db: Waiting
61c06e07759a: Waiting
bcbe43405751: Waiting
e1df5dc88d2c: Waiting
2689339b3663: Pushed
17c1e8f9ffc3: Pushed
91d4946853b1: Pushed
9d7471a4cb02: Pushed
cab1a1b91f96: Pushed
a607e4e78166: Pushed
481318f44378: Pushed
39e2be22c2a5: Pushed
9dcde2bd7f22: Pushed
0d701ea07f21: Pushed
ba1caa9ad1b8: Pushed
902245526746: Pushed
efba3aa8a05c: Pushed
a17e9881496c: Pushed
b800a9224768: Pushed
60e1a8618c67: Pushed
6c7b9546171d: Pushed
303c11dcd890: Pushed
746cca6f1abf: Pushed
dc918b50a9e0: Pushed
3b9f5a79fc86: Pushed
80ab47649ccb: Pushed
bc0d5482d762: Pushed
6691330056f3: Pushed
61c06e07759a: Pushed
bcbe43405751: Pushed
20c527f217db: Pushed
e1df5dc88d2c: Pushed
44246ca595f6: Pushed
v1: digest: sha256:ec637961685843d99ff22922749436407811c7bedb2ed65e7ba9508e9a4d540d size: 6379
+ az acr repository list --name democontainer22466 --output table
Result
----------------
azure-vote-front
+ az acr repository show-tags --name democontainer22466 --repository azure-vote-front --output table
Result
--------
v1
+ az provider register -n Microsoft.ContainerService
WARNING: Registering is still on-going. You can monitor using 'az provider show -n Microsoft.ContainerService'
+ az aks create -n demo-cluster -g demo-kube -l eastus --node-count 3 --ssh-key-value /home/ec2-user/.ssh/id_rsa.pub
{
  "additionalProperties": {},
  "agentPoolProfiles": [
    {
      "additionalProperties": {},
      "count": 3,
      "dnsPrefix": null,
      "fqdn": null,
      "name": "nodepool1",
      "osDiskSizeGb": null,
      "osType": "Linux",
      "ports": null,
      "storageProfile": "ManagedDisks",
      "vmSize": "Standard_DS1_v2",
      "vnetSubnetId": null
    }
  ],
  "dnsPrefix": "demo-clust-demo-kube-8fc81d",
  "fqdn": "demo-clust-demo-kube-8fc81d-d3ffbbd7.hcp.eastus.azmk8s.io",
  "id": "/subscriptions/8fc81d30-44f2-4be2-b49a-1f3537b4d50a/resourcegroups/demo-kube/providers/Microsoft.ContainerService/managedClusters/demo-cluster",
  "kubernetesVersion": "1.8.11",
  "linuxProfile": {
    "additionalProperties": {},
    "adminUsername": "azureuser",
    "ssh": {
      "additionalProperties": {},
      "publicKeys": [
        {
          "additionalProperties": {},
          "keyData": "ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA4mIeqyiOB1bH3bbZ47y2E1hF82JGxkgFW58BJovpQH/t3088yF63xfYrV4Ih9TUekamtCsZIrZOEgSPUsdso7GsERgn2/u7QtzzyCHgV8zHTETYIZ5/eUQXGN7+RqeusxK7HJQhs4Y5y327IuEmNCPw9tVbVbRWLOuVH2LMLeXRbCveI6GFEscN+qj44gZkrQkOY2mJY5NjJE0xIehHeX5x8ZP5lE6XLNbHeenV6uh4jyubVZmGm7guyjajVKKvhBbqpgp6OYOX27eKkVCdziMhOlfTqgEs6Rl2xb6cGhP5YgTn6yTcV842k9zOElQ/1ND817cm2IzNqjBHCAh8/uw== jacobsd@lx-dotoolsd1"
        }
      ]
    }
  },
  "location": "eastus",
  "name": "demo-cluster",
  "provisioningState": "Succeeded",
  "resourceGroup": "demo-kube",
  "servicePrincipalProfile": {
    "additionalProperties": {},
    "clientId": "97a5efd6-4cf9-4cd1-a88a-42ea6258f2ac",
    "keyVaultSecretRef": null,
    "secret": null
  },
  "tags": null,
  "type": "Microsoft.ContainerService/ManagedClusters"
}
+ az aks get-credentials -n demo-cluster -g demo-kube
Merged "demo-cluster" as current context in /home/ec2-user/.kube/config
+ kubectl cluster-info
[0;32mKubernetes master[0m is running at [0;33mhttps://demo-clust-demo-kube-8fc81d-d3ffbbd7.hcp.eastus.azmk8s.io:443[0m
[0;32mHeapster[0m is running at [0;33mhttps://demo-clust-demo-kube-8fc81d-d3ffbbd7.hcp.eastus.azmk8s.io:443/api/v1/namespaces/kube-system/services/heapster/proxy[0m
[0;32mKubeDNS[0m is running at [0;33mhttps://demo-clust-demo-kube-8fc81d-d3ffbbd7.hcp.eastus.azmk8s.io:443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy[0m
[0;32mkubernetes-dashboard[0m is running at [0;33mhttps://demo-clust-demo-kube-8fc81d-d3ffbbd7.hcp.eastus.azmk8s.io:443/api/v1/namespaces/kube-system/services/kubernetes-dashboard/proxy[0m

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
+ kubectl config view
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: REDACTED
    server: https://demo-clust-demo-kube-8fc81d-d3ffbbd7.hcp.eastus.azmk8s.io:443
  name: demo-cluster
contexts:
- context:
    cluster: demo-cluster
    user: clusterUser_demo-kube_demo-cluster
  name: demo-cluster
current-context: demo-cluster
kind: Config
preferences: {}
users:
- name: clusterUser_demo-kube_demo-cluster
  user:
    client-certificate-data: REDACTED
    client-key-data: REDACTED
    token: 187a4df4b0d5adacbd8685f650960ccc
+ kubectl get nodes
NAME                       STATUS    ROLES     AGE       VERSION
aks-nodepool1-26276800-0   Ready     agent     4m        v1.8.11
aks-nodepool1-26276800-1   Ready     agent     4m        v1.8.11
aks-nodepool1-26276800-2   Ready     agent     4m        v1.8.11
++ az aks show -n demo-cluster -g demo-kube --query servicePrincipalProfile.clientId --output tsv
+ CLIENT_ID=97a5efd6-4cf9-4cd1-a88a-42ea6258f2ac
++ az acr show -n democontainer22466 -g demo-kube --query id --output tsv
+ ACR_ID=/subscriptions/8fc81d30-44f2-4be2-b49a-1f3537b4d50a/resourceGroups/demo-kube/providers/Microsoft.ContainerRegistry/registries/democontainer22466
+ az role assignment create --assignee 97a5efd6-4cf9-4cd1-a88a-42ea6258f2ac --role Reader --scope /subscriptions/8fc81d30-44f2-4be2-b49a-1f3537b4d50a/resourceGroups/demo-kube/providers/Microsoft.ContainerRegistry/registries/democontainer22466
ERROR: The client 'Daren@eshumskygmail.onmicrosoft.com' with object id '394d0e9c-361e-445d-9946-d82c7af3e0c1' does not have authorization to perform action 'Microsoft.Authorization/roleAssignments/write' over scope '/subscriptions/8fc81d30-44f2-4be2-b49a-1f3537b4d50a/resourceGroups/demo-kube/providers/Microsoft.ContainerRegistry/registries/democontainer22466/providers/Microsoft.Authorization/roleAssignments/4040ea73-4f90-4a3c-9110-c74778fea600'.
